revised and improved version of the algo written in 2018.

Much faster and cleaner.
